#!/usr/bin/env python
# -*- coding: utf-8 -*-
import os
import sys

from optparse import OptionParser
import h5py
import numpy as np
import subspacefind

parser = OptionParser()

parser.add_option("-n", "--name",
                  help="dataset name [default=%default]", default="densities", type=str)
parser.add_option("-o", "--output",
                  help="output hdf5 file, default the same as input", default=None, type=str)
parser.add_option("-a", "--all", action="store_true", default=False, help="compute all densities")
(options, args) = parser.parse_args()

#h5file = h5py.File(args[0], "r", driver="core")
h5filename = os.path.abspath(args[0])
print "opening:", h5filename
h5file = h5py.File(h5filename) #, driver="core")

if options.output is not None:
	h5file_output = h5py.File(options.output)
else:
	h5file_output = h5file


if options.name not in h5file.keys():
	print options.name, "not found in file", h5filename
	sys.exit(1)

h5densities = h5file[options.name]
h5qualities = h5file_output.require_group("qualities")

if len(args) == 1:
	print "following densities available"
	for dim in ["1d", "2d", "3d"]:
		if dim in h5densities.keys():
			print dim, ":\t", "\n\t".join(h5densities[dim].keys())

basename = os.path.splitext(os.path.basename(h5filename))[0]
	
if options.all:
	for dim in [1,2,3]:
		name = str(dim) + "d"
		print "dim", name
		h5qualities_dim = h5qualities.require_group(name)
		#print h5densities.keys()
		#print h5densities
		if name not in h5densities:
			print "group", name, "not found, skipping"
			continue
		h5densities_dim = h5densities[name]
		for h5density_name in h5densities_dim.keys():
			h5density = h5densities_dim[h5density_name]
			h5quality = h5qualities_dim.require_group(h5density_name)
			dynamics, x, y = [], [], []
			if dim == 1:
				print "\t1d", h5density_name, "quality:\t",
				density = h5density["density"]
				#print density
				quality = subspacefind.maxtree1d_quality(density)
				dynamics, x, y = subspacefind.maxtree1d_dynamics(density)
				#print dynamics
				h5quality.attrs.modify("dynamics-x", x)
			if dim == 2:
				print "\t2d", h5density_name, "quality\t",
				density = h5density["density"]
				#print density
				quality = subspacefind.maxtree2d_quality(np.array(density) * 1.)
				dynamics, x, y = subspacefind.maxtree2d_dynamics(density)
				h5quality.attrs.modify("dynamics-x", x)
				h5quality.attrs.modify("dynamics-y", y)
			if dim == 3:
				print "\t3d", h5density_name, "quality\t",
				density = h5density["density"]
				quality = subspacefind.maxtree3d_quality(np.array(density) * 1., 4095)
			if h5file == h5file_output:
				# create a hard link
				if "density" in h5quality: del h5quality["density"]
				h5quality["density"] = h5density
			else:
				if "density" in h5quality.keys():
					print "remove density"
					del h5quality["density"]
				h5quality["density"] = h5py.ExternalLink(h5filename, "/" + options.name + "/" +name + "/"+ h5density_name)
				
			print "quality", quality
			print "mean quality", np.mean(dynamics)
			print "dynamics", dynamics
			h5quality.attrs.modify("quality", quality)
			h5quality.attrs.modify("dynamics", dynamics)
